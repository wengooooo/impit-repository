name: impitreq packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g. 0.1.0)'
        required: true
        type: string
  push:
    tags:
      - 'impitreq-v*'

jobs:
  platform:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform_pkg_dir: impitreq-win32-x64
            out_name: impitreq.dll
          - os: ubuntu-latest
            platform_pkg_dir: impitreq-linux-x64
            out_name: impitreq.so
          - os: macos-13
            platform_pkg_dir: impitreq-darwin-x64
            out_name: impitreq.dylib

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'http://8.217.204.199:4873'

      - name: Setup MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            mingw-w64-x86_64-gcc

      - name: Resolve version
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            echo "version=${GITHUB_REF_NAME#impitreq-v}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Build shared library (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          set -euo pipefail
          mkdir -p "${{ matrix.platform_pkg_dir }}"
          CGO_ENABLED=1 go build -tags=cshared -buildmode=c-shared -mod=mod -o "${{ matrix.platform_pkg_dir }}/${{ matrix.out_name }}" ./pkg/impit/cmd/impitreq

      - name: Build shared library (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${{ matrix.platform_pkg_dir }}"
          CGO_ENABLED=1 go build -tags=cshared -buildmode=c-shared -mod=mod -o "${{ matrix.platform_pkg_dir }}/${{ matrix.out_name }}" ./pkg/impit/cmd/impitreq

      - name: Set platform package version
        shell: bash
        env:
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          set -euo pipefail
          VERSION="$VERSION" node -e "const fs=require('fs'); const p='${{ matrix.platform_pkg_dir }}/package.json'; const j=JSON.parse(fs.readFileSync(p,'utf8')); j.version=process.env.VERSION; fs.writeFileSync(p, JSON.stringify(j,null,2)+'\n');"

      - name: Pack artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts
          npm pack "./${{ matrix.platform_pkg_dir }}" --pack-destination artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: impitreq-${{ matrix.platform_pkg_dir }}
          path: artifacts/*.tgz

      - name: Publish (optional)
        if: ${{ secrets.NPM_TOKEN != '' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          npm publish "./${{ matrix.platform_pkg_dir }}"

  main:
    runs-on: ubuntu-latest
    needs: platform
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'http://8.217.204.199:4873'

      - name: Resolve version
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            echo "version=${GITHUB_REF_NAME#impitreq-v}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Set main package version
        shell: bash
        env:
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          set -euo pipefail
          VERSION="$VERSION" node -e "const fs=require('fs'); const p='impitreq/package.json'; const j=JSON.parse(fs.readFileSync(p,'utf8')); j.version=process.env.VERSION; j.optionalDependencies['impitreq-win32-x64']=process.env.VERSION; j.optionalDependencies['impitreq-linux-x64']=process.env.VERSION; j.optionalDependencies['impitreq-darwin-x64']=process.env.VERSION; fs.writeFileSync(p, JSON.stringify(j,null,2)+'\n');"

      - name: Pack artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts
          npm pack "./impitreq" --pack-destination artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: impitreq-main
          path: artifacts/*.tgz

      - name: Publish (optional)
        if: ${{ secrets.NPM_TOKEN != '' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          npm publish "./impitreq"
