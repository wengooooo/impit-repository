name: impitreq packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g. 0.1.0)'
        required: true
        type: string
  push:
    tags:
      - 'impitreq-v*'

jobs:
  windows:
    runs-on: windows-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      PLATFORM_PKG_DIR: impitreq-win32-x64
      OUT_NAME: impitreq.dll
    steps:
      - uses: actions/checkout@v4
      - name: Resolve version
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            echo "version=${GITHUB_REF_NAME#impitreq-v}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          fi
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'
          cache: false
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      - name: Setup MSYS2 (Windows)
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MINGW64
          install: >-
            mingw-w64-x86_64-gcc
      - name: Check source exists
        id: checksrc
        shell: bash
        run: |
          set -euo pipefail
          SRC_DIR="./pkg/impit/cmd/impitreq"
          EXISTS="false"
          HAS_GO_FILES="false"
          HAS_GO_MOD="false"
          if [[ -d "$SRC_DIR" ]]; then
            EXISTS="true"
            if find "$SRC_DIR" -type f -name '*.go' | grep -q .; then
              HAS_GO_FILES="true"
            fi
          fi
          if [[ -f "./go.mod" || -f "$SRC_DIR/go.mod" ]]; then
            HAS_GO_MOD="true"
          fi
          CAN_BUILD="false"
          if [[ "$EXISTS" == "true" && "$HAS_GO_FILES" == "true" && "$HAS_GO_MOD" == "true" ]]; then
            CAN_BUILD="true"
          fi
          echo "exists=$EXISTS" >> "$GITHUB_OUTPUT"
          echo "has_go_files=$HAS_GO_FILES" >> "$GITHUB_OUTPUT"
          echo "has_go_mod=$HAS_GO_MOD" >> "$GITHUB_OUTPUT"
          echo "can_build=$CAN_BUILD" >> "$GITHUB_OUTPUT"
      - name: Build shared library (Windows)
        shell: msys2 {0}
        env:
          CGO_ENABLED: 1
          CC: gcc
        run: |
          set -euo pipefail
          if [[ '${{ steps.checksrc.outputs.can_build }}' != 'true' ]]; then
            echo 'Skipping Windows build: missing source/go files/go.mod'
            exit 0
          fi
          which gcc
          GO_BIN="$(ls -d /c/hostedtoolcache/windows/go/*/x64/bin 2>/dev/null | head -n 1 || true)"
          if [[ -d "$GO_BIN" ]]; then
            export PATH="$GO_BIN:$PATH"
          else
            pacman -Sy --noconfirm go
          fi
          go version
          mkdir -p "${PLATFORM_PKG_DIR}"
          go env
          go build -tags=cshared -buildmode=c-shared -mod=mod -o "${PLATFORM_PKG_DIR}/${OUT_NAME}" ./pkg/impit/cmd/impitreq
      - name: Upload Windows lib
        uses: actions/upload-artifact@v4
        with:
          name: win-lib
          path: ${{ env.PLATFORM_PKG_DIR }}/${{ env.OUT_NAME }}
      # Removed Windows package publish; publish happens in main job

  linux-centos:
    runs-on: ubuntu-latest
    container: quay.io/centos/centos:stream9
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      PLATFORM_PKG_DIR: impitreq-linux-x64
      OUT_NAME: impitreq.so
    steps:
      - uses: actions/checkout@v4
      - name: Resolve version
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            echo "version=${GITHUB_REF_NAME#impitreq-v}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          fi
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'
          cache: false
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      - name: Install toolchain
        shell: bash
        run: |
          set -euo pipefail
          dnf -y install gcc make glibc-devel
      - name: Check source exists
        id: checksrc
        shell: bash
        run: |
          set -euo pipefail
          SRC_DIR="./pkg/impit/cmd/impitreq"
          EXISTS="false"
          HAS_GO_FILES="false"
          HAS_GO_MOD="false"
          if [[ -d "$SRC_DIR" ]]; then
            EXISTS="true"
            if find "$SRC_DIR" -type f -name '*.go' | grep -q .; then
              HAS_GO_FILES="true"
            fi
          fi
          if [[ -f "./go.mod" || -f "$SRC_DIR/go.mod" ]]; then
            HAS_GO_MOD="true"
          fi
          CAN_BUILD="false"
          if [[ "$EXISTS" == "true" && "$HAS_GO_FILES" == "true" && "$HAS_GO_MOD" == "true" ]]; then
            CAN_BUILD="true"
          fi
          echo "exists=$EXISTS" >> "$GITHUB_OUTPUT"
          echo "has_go_files=$HAS_GO_FILES" >> "$GITHUB_OUTPUT"
          echo "has_go_mod=$HAS_GO_MOD" >> "$GITHUB_OUTPUT"
          echo "can_build=$CAN_BUILD" >> "$GITHUB_OUTPUT"
      - name: Build shared library (CentOS)
        if: steps.checksrc.outputs.can_build == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${{ env.PLATFORM_PKG_DIR }}"
          CGO_ENABLED=1 go build -tags=cshared -buildmode=c-shared -mod=mod -o "${{ env.PLATFORM_PKG_DIR }}/${{ env.OUT_NAME }}" ./pkg/impit/cmd/impitreq
      - name: Upload Linux lib
        uses: actions/upload-artifact@v4
        with:
          name: linux-lib
          path: ${{ env.PLATFORM_PKG_DIR }}/${{ env.OUT_NAME }}
      # Removed Linux package publish; publish happens in main job

  main:
    runs-on: ubuntu-latest
    needs: [windows, linux-centos]
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Resolve version
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            echo "version=${GITHUB_REF_NAME#impitreq-v}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          fi
      - name: Prepare prebuilds structure
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p impitreq/prebuilds/win32-x64
          mkdir -p impitreq/prebuilds/linux-x64
      - name: Download Windows lib
        uses: actions/download-artifact@v4
        with:
          name: win-lib
          path: impitreq/prebuilds/win32-x64
      - name: Download Linux lib
        uses: actions/download-artifact@v4
        with:
          name: linux-lib
          path: impitreq/prebuilds/linux-x64

      - name: Set main package version
        shell: bash
        env:
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          set -euo pipefail
          if [[ -n "${VERSION:-}" ]]; then
            VERSION="$VERSION" node -e "const fs=require('fs'); const p='impitreq/package.json'; const j=JSON.parse(fs.readFileSync(p,'utf8')); if(!j.name) throw new Error('package.json missing name'); j.version=process.env.VERSION; fs.writeFileSync(p, JSON.stringify(j,null,2)+'\n');"
          else
            echo 'No VERSION provided; keep existing impitreq/package.json version and optionalDependencies'
          fi

      - name: Pack artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts
          npm pack "./impitreq" --pack-destination artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: impitreq-main
          path: artifacts/*.tgz

      - name: Publish (optional)
        if: ${{ env.NODE_AUTH_TOKEN != '' }}
        shell: bash
        run: |
          set -euo pipefail
          npm publish "./impitreq"

  verify:
    runs-on: windows-latest
    needs: main
    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      - name: Download main package artifact
        uses: actions/download-artifact@v4
        with:
          name: impitreq-main
          path: verify
      - name: Install koffi and package, then verify load
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          cd verify
          npm init -y
          npm i koffi
          $tgz = Get-ChildItem -Filter "impitreq-*.tgz" | Select-Object -First 1
          if (-not $tgz) { throw "impitreq tgz not found in verify/" }
          npm i "./$($tgz.Name)"
          node -e @"
          const fs = require('fs');
          const koffi = require('koffi');
          const imp = require('impitreq');
          const p = imp.getLibPath();
          if (!fs.existsSync(p)) throw new Error('lib not found: ' + p);
          const lib = koffi.load(p);
          console.log('koffi loaded:', p);
          "@
